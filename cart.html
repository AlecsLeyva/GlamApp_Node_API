<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Glam App</title>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0; 
            background-color: #fce4ec; 
            color: #4a4a4a;
        }

        nav {
            background-color: #f06292; 
            padding: 15px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        nav a {
            font-family: 'Open Sans', sans-serif;
            color: white;
            text-decoration: none;
            font-weight: 600;
            margin: 0 25px;
            font-size: 1.1em;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .cart-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cart-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #880e4f;
            margin: 0;
        }

        .item-price {
            color: #d81b60;
            font-size: 1.1em;
            font-weight: bold;
        }

        .remove-btn {
            color: #f06292;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.2em;
        }

        .cart-total {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: right;
        }

        #paypal-button-container {
            max-width: 300px;
            margin: 20px 0 0 auto;
        }

        .empty-cart {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
        }

        .back-to-store {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #f06292;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav>
        <a href="ProyectoUni2APIS.html">üíÑ Productos</a>
        <a href="cart.html">üõçÔ∏è Carrito</a>
        <a href="profile.html">üë§ Perfil</a>
    </nav>

    <div class="container">
        <h1>Tu Carrito de Compras</h1>
        
        <div id="cart-items">    <!-- Los items del carrito se insertar√°n aqu√≠ -->
           
        </div>

        <div id="cart-total" class="cart-total" style="display: none;">
            <h3>Total: <span id="total-amount">$0.00 MXN</span></h3>
            <div id="paypal-button-container"></div>
        </div>

        <div id="empty-cart-message" class="empty-cart">
            <h2>Tu carrito est√° vac√≠o</h2>
            <p>¬°Agrega algunos productos maravillosos!</p>
            <a href="ProyectoUni2APIS.html" class="back-to-store">Volver a la tienda</a>
        </div>
    </div>

    <script src="https://www.paypal.com/sdk/js?client-id=test&currency=MXN"></script>
    <script>
        // Usar localStorage para el carrito
        let cart = JSON.parse(localStorage.getItem('glamAppCart') || '[]');

        function removeFromCart(id) {
            // compatible ES5: use filter with function
            cart = cart.filter(function(item){ return item.id !== id; });
            localStorage.setItem('glamAppCart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function clearCart() {
            cart = [];
            localStorage.setItem('glamAppCart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const emptyMessage = document.getElementById('empty-cart-message');

            // Normalizar cart por id para evitar duplicados (ES5)
            var normalizedMap = {};
            for (var i = 0; i < cart.length; i++) {
                var item = cart[i];
                var q = item.quantity || 1;
                if (normalizedMap[item.id]) {
                    normalizedMap[item.id].quantity += q;
                } else {
                    normalizedMap[item.id] = Object.assign({}, item, { quantity: q });
                }
            }
            cart = Object.values(normalizedMap);
            localStorage.setItem('glamAppCart', JSON.stringify(cart));

            if (cart.length === 0) {
                cartItems.style.display = 'none';
                cartTotal.style.display = 'none';
                emptyMessage.style.display = 'block';
                return;
            }

            cartItems.style.display = 'block';
            cartTotal.style.display = 'block';
            emptyMessage.style.display = 'none';

            let total = 0;
            var parts = [];
            for (var k = 0; k < cart.length; k++) {
                var it = cart[k];
                var qty2 = it.quantity || 1;
                var itemTotal2 = parseFloat(it.price) * qty2;
                total += itemTotal2;
                parts.push('\n                    <div class="cart-item">\n                        <img src="' + it.image + '" alt="' + it.name + '">\n                        <div class="item-details">\n                            <h3 class="item-name">' + it.name + '</h3>\n                            <div class="item-quantity">\n                                <button onclick="changeQuantity(\'' + it.id + '\', -1)">‚àí</button>\n                                <span style="margin:0 8px">' + qty2 + '</span>\n                                <button onclick="changeQuantity(\'' + it.id + '\', 1)">+</button>\n                            </div>\n                            <div class="item-price">$' + itemTotal2.toFixed(2) + ' MXN</div>\n                        </div>\n                        <button class="remove-btn" onclick="removeFromCart(\'' + it.id + '\')">‚ùå</button>\n                    </div>\n                ');
            }
            cartItems.innerHTML = parts.join('');

            document.getElementById('total-amount').textContent = '$' + total.toFixed(2) + ' MXN';

            // Configurar PayPal con detalle de productos
            // Limpia el contenedor antes de re-render para evitar m√∫ltiples instancias
            const ppContainer = document.getElementById('paypal-button-container');
            if (ppContainer) ppContainer.innerHTML = '';

            paypal.Buttons({
                createOrder: function(data, actions) {
                    // Leer el carrito actualizado desde localStorage para obtener valores correctos
                    const currentCart = JSON.parse(localStorage.getItem('glamAppCart') || '[]');
                    let currentTotal = 0;
                    var items = [];
                    for (var m = 0; m < currentCart.length; m++) {
                        var ci = currentCart[m];
                        var qty3 = ci.quantity || 1;
                        var itemTotal3 = parseFloat(ci.price) * qty3;
                        currentTotal += itemTotal3;
                        items.push({
                            name: ci.name,
                            unit_amount: {
                                value: ci.price,
                                currency_code: 'MXN'
                            },
                            quantity: qty3
                        });
                    }

                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: currentTotal.toFixed(2),
                                breakdown: {
                                    item_total: {
                                        value: currentTotal.toFixed(2),
                                        currency_code: 'MXN'
                                    }
                                }
                            },
                            items: items
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        alert('¬°Pago completado! Gracias por tu compra, ' + (details.payer && details.payer.name && details.payer.name.given_name || 'cliente'));
                        clearCart(); // Limpiar carrito usando nuestra funci√≥n
                    });
                }
            }).render('#paypal-button-container');
        }

        function changeQuantity(id, delta) {
            const idx = cart.findIndex(item => item.id === id);
            if (idx === -1) return;
            cart[idx].quantity = (cart[idx].quantity || 1) + delta;
            if (cart[idx].quantity <= 0) {
                cart.splice(idx, 1);
            }
            localStorage.setItem('glamAppCart', JSON.stringify(cart));
            updateCartDisplay();
        }

        // Inicializar visualizaci√≥n
        updateCartDisplay();
    </script>
    <script src="auth/auth-check.js"></script>
    <script>
        if (typeof requireAuth === 'function') {
            requireAuth();
        }
    </script>
</body>
</html>